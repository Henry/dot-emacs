#!/bin/bash
set -x -e

EMACS=`which emacs`
TEMACS=/usr/local/src/emacs-25.1/src/temacs
EMACSDOC=/usr/local/share/emacs/25.1/etc/

if which setarch >& /dev/null
then
case `uname -m` in
    i686)
    EMACS="setarch i386 -R `which emacs`"
    ;;
    x86_64)
    EMACS="setarch x86_64 -R `which emacs`"
    ;;
esac
fi

rm -rf ~/bin/linux/eemacs

echo "Compiling elpa packages"
$EMACS --eval "(byte-recompile-directory (expand-file-name \"~/.emacs.d/elpa\") 0)" --batch

echo ";; Automatically generated by makeEemacs" > init-eemacs.el
echo ";; Automatically generated by makeEemacs" > load-eemacs.el
sed -f bin/sedLoadPath init.el >> init-eemacs.el
find init -name "*.el" -exec sed -f bin/sedLoadPath {} \; >> init-eemacs.el
find my-lisp -name "*.el" -exec sed -f bin/sedLoadPath {} \; >> init-eemacs.el
grep "init-eemacs" ~/.emacs.d/init/qinit.el >> init-eemacs.el
grep "init-eemacs" ~/.emacs.d/init.el >> init-eemacs.el
grep -v "init-eemacs" ~/.emacs.d/init.el >> load-eemacs.el

make

# Ensure the documentation for built-in functions and variables is available to temacs
rm -f ../etc
ln -s $EMACSDOC ../etc

$TEMACS -q --batch \
    --eval "(setq delete-old-versions t)" \
    --load load-eemacs.el \
    --eval "(setq command-line-processed nil)" \
    --eval "(dump-emacs \"~/bin/linux/eemacs\" \"$TEMACS\")"

# Remove the temporary link to the documentation
rm ../etc

bin/makeTAGS
