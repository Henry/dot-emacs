#!/bin/bash
set -x -e

export HOME=~

EMACS=/usr/local/bin/emacs
EMACS_VERSION=$($EMACS --version |  grep "GNU Emacs [0-9][0-9.]*" | sed s/"GNU Emacs \([1-9][0-9]\.[0-9]\)\.[0-9]/\1/")
TEMACS=/usr/local/src/emacs-$EMACS_VERSION/src/temacs
EMACSDOC=/usr/local/share/emacs/$EMACS_VERSION/etc/

if which setarch >& /dev/null
then
case `uname -m` in
    i686)
    EMACS="setarch i386 -R `which emacs`"
    ;;
    x86_64)
    EMACS="setarch x86_64 -R `which emacs`"
    ;;
esac
fi

echo "Compiling elpa packages"
$EMACS --eval "(byte-recompile-directory (expand-file-name \"~/Emacs/elpa\") 0)" --batch

echo ";; Automatically generated by makeEemacs" > init-eemacs.el
echo ";; Automatically generated by makeEemacs" > load-eemacs.el
sed -f bin/sedLoadPath init.el >> init-eemacs.el
find init -name "*.el" -exec sed -f bin/sedLoadPath {} \; >> init-eemacs.el
find my-lisp -name "*.el" -exec sed -f bin/sedLoadPath {} \; >> init-eemacs.el
grep "init-eemacs" ~/.emacs.d/init/qinit.el >> init-eemacs.el
grep "init-eemacs" ~/.emacs.d/init.el >> init-eemacs.el
grep -v "init-eemacs" ~/.emacs.d/init.el >> load-eemacs.el

make

# Ensure the documentation for built-in functions and variables is available to temacs
rm -f ../etc
ln -s $EMACSDOC ../etc

$TEMACS \
    -q --batch \
    --eval "(setq delete-old-versions t)" \
    -L ~/.emacs.d/init \
    --load load-eemacs.el \
    --eval "(setq command-line-processed nil)" \
    --eval "(dump-emacs \"~/bin/linux/eemacs.new\" \"$TEMACS\")"

# Remove the temporary link to the documentation
rm ../etc

# If the build was successful update eemacs
if [ -f ~/bin/linux/eemacs.new ]
then
    mv ~/bin/linux/eemacs ~/bin/linux/eemacs.old
    mv ~/bin/linux/eemacs.new ~/bin/linux/eemacs

    # and build the tags files
    bin/makeTAGS
fi
